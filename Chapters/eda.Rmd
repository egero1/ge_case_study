# Exploratory Data Analysis

Note in __Table 1__ that the count of observations by segment differs. This indicates that not all of the `r length(unique(full$PatientNumMasked))` unique patients have observations for all lung segments. 

```{r observations, echo = FALSE}

observations <- use_data %>% 
        group_by(Position) %>%
        summarize(Count = n())

observations$Position <- as.character(observations$Position)
observations <- rbind(observations, c('Total', sum(observations$Count)))
kable(observations, caption = "Lung Segment Observations", booktabs = TRUE) %>% 
        kable_styling(font_size = 8,  latex_options = c("striped"))

```

```{r check_labels, echo = FALSE}

# Verify that all labels for patients are the same
checklabel <- full %>%
        group_by(PatientNumMasked) %>%
        mutate(minLabel = min(Label)) %>%
        mutate(maxLabel = max(Label)) %>%
        mutate(count = length(PatientNumMasked)) %>%
        dplyr::select(PatientNumMasked, minLabel, maxLabel, count) 

# If the min and max are equal, they will be dropped.  If list is empty
# then the label is consistent across data sets for all patients
checklabel <- checklabel %>%
        dplyr::filter(minLabel != maxLabel)

checklabel <- ifelse(dim(checklabel)[1] == 0, 'no', dim(checklabel)[1])

```

Since the lung images from each patient are broken into six segments and each tab contains the patient number and the label, it is possible that the labels for a patient do not match across the six segments. This is not much of an issue at the segment level, but it is important that it is taken into account if the data is rolled up or combined into a single table. If the label for any segement is 'Abnormal', then it should be considered that disease is present in the patient, regardless of the value of the other segment labels. It is confirmed that `r checklabel` patients have inconsistent label values.




variables in use_data_lc are quite different than those selected by rfe

The correlation plot in __Figure 2__ shows that some of the predictors have strong correlations with each other. This requires further investigation as high correlation among predictors can cause instability in the model. Generally, when two variables are highly correlated, it is best to remove one since the second is not providing new information.

```{r correlation, echo = FALSE, out.width = '350px', fig.cap = 'Correlation Matrix', fig.align = "center", fig.pos = 'H'}

# Correlation between predictors
corr <- cor(use_data[-c(40,41)])
corrplot(corr, type = "upper", tl.cex = 0.5, tl.col = "blue", tl.srt = 45)

```

```{r high_correlation, echo = FALSE}

# Review and remove highly correlated predictors
correlationMatrix <- cor(use_data[-c(40,41)])
highCorrelation <- findCorrelation(correlationMatrix, cutoff = 0.50)
rows <- length(colnames(use_data[highCorrelation]))
highly_correlated <- data.frame("Correlated Variables 1" = colnames(use_data[highCorrelation])[1:(rows / 2)], 
                                "Correlated Variables 2" = colnames(use_data[highCorrelation])[(rows/2 + 1):rows])

kable(highly_correlated, caption = "Highly Correlated Variables", booktabs = TRUE, col.names = c('', '')) %>% 
        kable_styling(font_size = 8, position = 'float_right', latex_options = c("striped", "hold_position"))

```

```{r new_correlation, echo = FALSE, out.width = '350px', fig.cap = 'Correlation Matrix - Highly Correlated Variables Removed', fig.align = "center", fig.pos = 'H'}
use_data_lc <- use_data[,-highCorrelation]
low_corr <- use_data_lc %>%
        select(-Position, -Label)
low_corr<- cor(low_corr)

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(low_corr, method = "color", col = col(200),
         type = "upper", order = "hclust", number.cex = .7,
         addCoef.col = "black", # Add coefficient of correlation
         tl.col = "blue", tl.srt = 45, tl.cex = 0.5, # Text label color and rotation
         # Combine with significance
         sig.level = 0.01, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag = FALSE)

```

Talk about box plots here
```{r boxplots, echo = FALSE, out.width = '350px', fig.cap = 'Boxplots', fig.align = "center", fig.pos = 'H'}

# Check for outliers
plots <- list(0)
for(var in 3:4) {
        p <- ggplot(data = use_data, aes(x = '', y = use_data[,var])) + 
                geom_boxplot(color='red', fill='orange', alpha = 0.2) +
                labs(title = paste('Outliers - ', colnames(use_data[var]))) +
                ylab('Boxplot') +
        coord_cartesian(ylim = c(min(use_data[,var]), max(use_data[,var])))
        plots[[var-2]] <- p
}

grid.arrange(plots[[1]], plots[[2]], ncol = 2)


```